name: Data Sync
on:
  schedule:
    - cron: '*/15 * * * *' # Every 15 minutes for traffic/weather/ais
    - cron: '0 6 * * *' # Daily at 6am for sea quality
  workflow_dispatch: # Manual trigger
  push:
    paths:
      - 'scripts/*.ps1' # Run when scripts change

permissions:
  contents: write

jobs:
  sync-data:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Check PowerShell version
        run: pwsh -v

      - name: Create Config
        run: |
          cat > config.local.js << 'EOF'
          window.LOCAL_CONFIG = {
            urls: {
              npt: "https://b2b.promet-info.hr"
            },
            // Legacy keys for sync-raw-data.ps1 regex
            user: '${{ secrets.NPT_USER }}',
            pass: '${{ secrets.NPT_PASS }}',
            // Modern keys for app
            nptUser: '${{ secrets.NPT_USER }}',
            nptPass: '${{ secrets.NPT_PASS }}',
            AISSTREAM_API_KEY: '${{ secrets.AISSTREAM_API_KEY }}',
            FERRY_MMSI: '238118840',
            ENABLE_REAL_AIS: true
          };
          EOF

      - name: Install dependencies
        run: npm install ws

      - name: Fetch Traffic Data (NPT)
        run: |
          pwsh -File ./scripts/sync-raw-data.ps1
        continue-on-error: true

#      - name: Fetch AIS Snapshot (Real-Time)
#        env:
#          AISSTREAM_API_KEY: ${{ secrets.AISSTREAM_API_KEY }}
#        run: |
#          node scripts/sync-ais-snapshot.js
#        continue-on-error: true

      - name: Fetch Cameras (once)
        run: |
          pwsh -File ./scripts/sync-cameras.ps1
        continue-on-error: true

      - name: Process Data
        run: |
          pwsh -File ./scripts/process-data.ps1
        continue-on-error: true



      - name: Prepare Commit (Pull & Rebase)
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git pull --rebase --autostash origin main

      - name: Commit Traffic Data
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'chore: sync traffic/weather/ais data'
          file_pattern: 'data/traffic*.json data/traffic*.js data/ais-snapshot.json'


  sync-sea-quality:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '0 6 * * *'
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Check PowerShell version
        run: pwsh -v

      - name: Fetch Sea Quality (IZOR)
        run: |
          pwsh -File ./scripts/sync-izor.ps1
        continue-on-error: true

      - name: Prepare Commit (Pull & Rebase)
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git pull --rebase --autostash origin main

      - name: Commit Sea Quality Data
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'chore: sync sea quality data'
          file_pattern: 'data/sea-quality*'
